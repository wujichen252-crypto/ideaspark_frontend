<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>IdeaSpark — 专业级市场分析 Dashboard（示例）</title>

<!-- ECharts -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<style>
  :root{
    --accent:#2E8B57; --muted:#6b7280; --card:#fff;
    font-family: Inter, "Helvetica Neue", Arial, sans-serif;
    background: linear-gradient(180deg,#f7fbf8,#f2f6f4);
    color:#0f172a;
  }
  *{box-sizing:border-box}
  body{margin:0;padding:18px 16px 80px}
  .wrap{max-width:1300px;margin:0 auto}
  .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#3CB371);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700}
  h1{font-size:18px;margin:0}
  .controls{display:flex;gap:10px;align-items:center}
  .btn{padding:8px 12px;border-radius:999px;border:0;background:#fff;box-shadow:0 6px 18px rgba(15,23,42,0.06);cursor:pointer}
  .panel{background:var(--card);border-radius:12px;padding:12px;margin-bottom:12px;box-shadow:0 10px 28px rgba(15,23,42,0.06)}
  .row{display:flex;gap:12px}
  .col{flex:1}
  .side{width:320px}
  .search{display:flex;gap:8px}
  input[type="search"]{padding:10px 12px;border-radius:999px;border:1px solid #e8eef0;flex:1}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 12px}
  .tab{padding:8px 12px;border-radius:999px;background:#f3f6f5;cursor:pointer;font-weight:600;color:var(--muted)}
  .tab.active{background:var(--accent);color:white;box-shadow:0 8px 20px rgba(46,139,87,0.12)}
  .kpi-grid{display:flex;gap:10px;flex-wrap:wrap}
  .kpi{flex:1;min-width:150px;padding:12px;border-radius:10px;background:linear-gradient(180deg,#fff,#fbfffb);box-shadow:0 8px 18px rgba(15,23,42,0.05)}
  .kpi .k{font-size:12px;color:var(--muted)}
  .kpi .v{font-weight:700;font-size:18px}
  .charts-grid{display:grid;grid-template-columns:2fr 1fr;gap:12px}
  .small-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  .projects{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:12px}
  .project{background:#fff;border-radius:10px;overflow:hidden;box-shadow:0 10px 30px rgba(15,23,42,0.06);transition:.18s}
  .project:hover{transform:translateY(-8px)}
  .thumb{height:110px;background:#eee}
  .p-body{padding:10px}
  .muted{color:var(--muted);font-size:13px}
  .footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}
  @media(max-width:1000px){
    .charts-grid{grid-template-columns:1fr}
    .projects{grid-template-columns:repeat(2,1fr)}
    .side{width:100%}
  }
  @media(max-width:600px){
    .projects{grid-template-columns:1fr}
    input[type="search"]{width:100%}
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div class="brand">
      <div class="logo">IS</div>
      <div>
        <h1>IdeaSpark — 高级市场分析仪表盘</h1>
        <div class="muted">10 个专业模块 · 模拟数据 · 可交互预览</div>
      </div>
    </div>
    <div class="controls">
      <div class="search panel" style="padding:8px;">
        <input id="globalSearch" type="search" placeholder="搜索项目 / 标签 / 公司（示例数据）">
        <button class="btn" onclick="doSearch()">搜索</button>
      </div>
      <button class="btn" onclick="regenAll()">刷新数据</button>
      <button class="btn" onclick="exportSnapshot()">导出快照</button>
    </div>
  </div>

  <!-- tabs -->
  <div class="tabs" id="tabs"></div>

  <!-- KPI + Market Cycle + Pulse -->
  <div class="row" style="margin-bottom:12px">
    <div class="col panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">市场概览 · KPI</div>
        <div class="muted">更新时间：<span id="updatedAt"></span></div>
      </div>
      <div style="height:12px"></div>
      <div class="kpi-grid" id="kpiGrid"></div>
    </div>
    <div class="side panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">今日市场动向</div>
        <div class="muted">Pulse</div>
      </div>
      <div style="height:8px"></div>
      <div id="pulseArea" class="muted"></div>
      <div style="height:12px"></div>
      <div style="font-weight:700">行业快速筛选</div>
      <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
        <button class="btn" onclick="quick('growth')">增长最快</button>
        <button class="btn" onclick="quick('hot')">最热项目</button>
        <button class="btn" onclick="quick('new')">最近新增</button>
      </div>
    </div>
  </div>

  <!-- charts main -->
  <div class="charts-grid">
    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">行业趋势 & 周期识别</div>
        <div style="display:flex;gap:8px">
          <select id="metricSelect" onchange="updateMetric()">
            <option value="count">创建量（默认）</option>
            <option value="views">浏览量</option>
            <option value="favorites">收藏量</option>
            <option value="sales">成交量</option>
          </select>
          <select id="rangeSelect" onchange="updateRange()">
            <option value="14">14天</option>
            <option value="30" selected>30天</option>
            <option value="90">90天</option>
            <option value="180">180天</option>
          </select>
        </div>
      </div>
      <div id="trendChart" style="height:320px;margin-top:8px"></div>
      <div style="display:flex;gap:12px;margin-top:8px">
        <div style="flex:1">
          <div style="font-weight:700;margin-bottom:6px">趋势动能雷达</div>
          <div id="momentumRadar" style="height:220px"></div>
        </div>
        <div style="width:360px">
          <div style="font-weight:700;margin-bottom:6px">行业变动事件 & 异常</div>
          <div id="anomalyList" class="muted" style="height:140px;overflow:auto"></div>
          <div style="height:12px"></div>
          <div style="font-weight:700;margin-bottom:6px">领先 / 滞后对比（示例）</div>
          <div id="leadLag" style="height:120px"></div>
        </div>
      </div>
    </div>

    <div class="panel">
      <div style="font-weight:700">多行业同步性 · HHI · 关联</div>
      <div style="height:220px;margin-top:8px" id="syncHeatmap"></div>
      <div style="height:8px"></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <div style="flex:1">
          <div style="font-weight:700;font-size:13px">HHI（行业集中度）</div>
          <div id="hhiList" class="muted" style="margin-top:8px"></div>
        </div>
        <div style="width:200px">
          <div style="font-weight:700;font-size:13px">行业溢出（关联强度）</div>
          <div id="sankey" style="height:120px"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- velocity zones + density -->
  <div class="small-grid" style="margin-top:12px">
    <div class="panel">
      <div style="font-weight:700">趋势变速带（Velocity Zones）</div>
      <div id="velocityChart" style="height:220px;margin-top:8px"></div>
    </div>
    <div class="panel">
      <div style="font-weight:700">竞争拥挤度（Density）</div>
      <div id="densityChart" style="height:220px;margin-top:8px"></div>
    </div>
  </div>

  <!-- compare & forecast -->
  <div class="row" style="margin-top:12px">
    <div class="col panel">
      <div style="font-weight:700">行业对比（条形）</div>
      <div id="compareBar" style="height:260px;margin-top:8px"></div>
    </div>
    <div class="side panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">未来预测窗口（7/14/30天）</div>
        <div>
          <select id="forecastHorizon" onchange="renderForecast()">
            <option value="7">7天</option><option value="14" selected>14天</option><option value="30">30天</option>
          </select>
        </div>
      </div>
      <div id="forecastChart" style="height:230px;margin-top:8px"></div>
    </div>
  </div>

  <!-- projects -->
  <div class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:700">当前最热用户项目（示例）</div>
      <div class="muted">按系统评分（浏览+收藏+增长）</div>
    </div>
    <div class="projects" id="projectGrid"></div>
    <div style="height:12px"></div>
    <div style="display:flex;justify-content:center;gap:8px">
      <button class="btn" onclick="prevPage()">上一页</button>
      <div id="pageInfo" class="muted"></div>
      <button class="btn" onclick="nextPage()">下一页</button>
    </div>
  </div>

  <div class="footer">IdeaSpark Demo · 专业模块示例 © 2025</div>
</div>

<script>
/* ============================
   数据模拟 & 全局状态
   ============================ */
const INDUSTRIES = ['AI','科技','金融','制造','设计','电商','游戏'];
const daysTotal = 180;
let state = {
  industry: 'AI',
  metric: 'count',
  range: 30,
  horizon: 14,
  page: 1,
  perPage: 8
};
let timeSeries = {}; // industry -> array of {date, count, views, favorites, sales, search}
let projects = [];

/* 生成日期序列 */
function genDates(n){
  const arr=[];
  for(let i=n-1;i>=0;i--){
    const d=new Date(); d.setDate(d.getDate()-i);
    arr.push(`${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')}`);
  }
  return arr;
}

/* 生成模拟时间序列（可控随机性） */
function genData(){
  const dates = genDates(daysTotal);
  INDUSTRIES.forEach(ind=>{
    const base = Math.floor(200 + Math.random()*1000) * (ind==='AI'?1.6:1);
    const arr = [];
    // create initial pattern + occasional pulses
    let trend = (Math.random()*0.6 - 0.1); // small slope
    for(let i=0;i<dates.length;i++){
      // seasonal weekly + random walk
      const week = i%7;
      const seasonal = 1 + Math.sin((i/7)*Math.PI*2)/8 + (week===0?0.05:0);
      // occasional event
      const event = Math.random() < 0.02 ? (1 + Math.random()*2) : 1;
      const noise = (Math.random()-0.5)*0.18;
      trend += (Math.random()-0.5)*0.002; // drift
      const count = Math.max(0, Math.round(base * (1 + trend) * seasonal * event * (1 + noise)));
      const views = Math.round(count * (20 + Math.random()*200));
      const favorites = Math.round(count * (0.2 + Math.random()*3));
      const sales = Math.round(count * (0.05 + Math.random()*0.6));
      const search = Math.round(count * (0.5 + Math.random()*6));
      arr.push({date:dates[i],count,views,favorites,sales,search});
    }
    timeSeries[ind]=arr;
  });
  // projects
  projects = [];
  const types = ['tool','template','component','service'];
  for(let i=1;i<=60;i++){
    const ind = INDUSTRIES[Math.floor(Math.random()*INDUSTRIES.length)];
    projects.push({
      id:i,
      title: `${ind} 项目 ${i}`,
      desc: ['轻量级','企业级','高性能','创新型','开源'][Math.floor(Math.random()*5)],
      industry:ind,
      type: types[Math.floor(Math.random()*types.length)],
      price: Math.random()>0.6 ? 'paid':'free',
      score: Math.floor(Math.random()*1000),
      views: Math.floor(Math.random()*50000),
      created: new Date(Date.now()-Math.random()*1000*60*60*24*90).toISOString().slice(0,10)
    });
  }
}

/* ============================
   统计 / 分析函数（简化版）
   ============================ */

/* 取当前行业序列 */
function series(ind=state.industry){ return timeSeries[ind] || []; }

/* 计算简单斜率（线性回归） */
function slope(data, field, lastN=30){
  const arr = data.slice(-lastN).map((d,i)=>[i, d[field]]);
  const n = arr.length;
  if(n<2) return 0;
  const xs = arr.map(a=>a[0]), ys = arr.map(a=>a[1]);
  const xbar = xs.reduce((a,b)=>a+b,0)/n;
  const ybar = ys.reduce((a,b)=>a+b,0)/n;
  let num=0, den=0;
  for(let i=0;i<n;i++){ num += (xs[i]-xbar)*(ys[i]-ybar); den += (xs[i]-xbar)**2; }
  return den===0?0:num/den;
}

/* 波动率 */
function volatility(data, field, lastN=30){
  const arr = data.slice(-lastN).map(d=>d[field]);
  const mean = arr.reduce((a,b)=>a+b,0)/arr.length;
  const sd = Math.sqrt(arr.reduce((a,b)=>a+(b-mean)**2,0)/arr.length);
  return sd/Math.max(1, mean);
}

/* 检测异常点（> mean + 3*sd） */
function detectAnomalies(data, field){
  const arr = data.map(d=>d[field]);
  const mean = arr.reduce((a,b)=>a+b,0)/arr.length;
  const sd = Math.sqrt(arr.reduce((a,b)=>a+(b-mean)**2,0)/arr.length);
  const res=[];
  data.forEach(d=>{
    if(d[field] > mean + 3*sd){
      res.push({date:d.date, value:d[field]});
    }
  });
  return res;
}

/* 计算相关矩阵（Pearson） */
function correlationMatrix(){
  const names = INDUSTRIES;
  const mat = Array.from({length:names.length},()=>Array(names.length).fill(0));
  for(let i=0;i<names.length;i++){
    for(let j=0;j<names.length;j++){
      const a = timeSeries[names[i]].map(d=>d.count);
      const b = timeSeries[names[j]].map(d=>d.count);
      const n = a.length;
      const meanA = a.reduce((s,v)=>s+v,0)/n;
      const meanB = b.reduce((s,v)=>s+v,0)/n;
      let num=0, da=0, db=0;
      for(let k=0;k<n;k++){ num += (a[k]-meanA)*(b[k]-meanB); da += (a[k]-meanA)**2; db += (b[k]-meanB)**2; }
      const r = num / Math.sqrt(Math.max(1e-9, da*db));
      mat[i][j] = Number.isFinite(r)?r:0;
    }
  }
  return {names, mat};
}

/* HHI (行业集中度): 使用项目 score 模拟份额 */
function computeHHI(){
  const groups = {};
  projects.forEach(p=>{
    groups[p.industry] = groups[p.industry] || [];
    groups[p.industry].push(p.score);
  });
  const result = [];
  for(const ind of INDUSTRIES){
    const arr = groups[ind] || [];
    const total = arr.reduce((a,b)=>a+b,0) || 1;
    const shares = arr.map(v=>v/total);
    const hhi = shares.reduce((a,s)=>a + s*s,0);
    result.push({industry:ind, hhi: Number(hhi.toFixed(3)), topShare: Math.max(...shares,0).toFixed(2)});
  }
  return result.sort((a,b)=>b.hhi-a.hhi);
}

/* 多行业溢出（基于高相关对） */
function computeSankeyLinks(){
  const corr = correlationMatrix();
  const names = corr.names;
  const mat = corr.mat;
  const links = [];
  for(let i=0;i<names.length;i++){
    for(let j=0;j<names.length;j++){
      if(i!==j && Math.abs(mat[i][j])>0.6){
        links.push({source:names[i], target:names[j], value: Math.round(Math.abs(mat[i][j])*100)});
      }
    }
  }
  return {nodes:names.map(n=>({name:n})), links};
}

/* 预测：简单线性回归 + 误差带（std） */
function forecast(ind=state.industry, field='count', horizon=14){
  const data = timeSeries[ind].slice(-60); // last 60 days
  const xs = data.map((d,i)=>i), ys = data.map(d=>d[field]);
  const n = xs.length;
  const xbar = xs.reduce((a,b)=>a+b,0)/n;
  const ybar = ys.reduce((a,b)=>a+b,0)/n;
  let num=0, den=0;
  for(let i=0;i<n;i++){ num += (xs[i]-xbar)*(ys[i]-ybar); den += (xs[i]-xbar)**2; }
  const slope = den?num/den:0;
  const intercept = ybar - slope*xbar;
  // residuals
  const residuals = ys.map((y,i)=>y - (intercept + slope*xs[i]));
  const sd = Math.sqrt(residuals.reduce((a,b)=>a+b*b,0)/Math.max(1,n-2));
  const preds = [];
  for(let h=1;h<=horizon;h++){
    const x = n-1 + h;
    const meanPred = intercept + slope*x;
    // simple CI: mean ± 1.96*sd
    const lower = Math.max(0, Math.round(meanPred - 1.96*sd));
    const upper = Math.round(meanPred + 1.96*sd);
    preds.push({day:h, mean: Math.round(meanPred), lower, upper});
  }
  return preds;
}

/* ============================
   渲染函数（各图）
   ============================ */

let trendChart, radarChart, compareChart, heatChart, sankeyChart, velocityChart, densityChart, forecastChart, leadLagChart;

/* 趋势图 + 周期识别 + anomaly标记 + trend velocity color bands */
function renderTrend(){
  const data = series();
  const range = state.range;
  const arr = data.slice(-range);
  const x = arr.map(d=>d.date);
  const vals = arr.map(d=>d[state.metric]);

  // anomalies
  const anomalies = detectAnomalies(data, state.metric);

  // compute slope & volatility for cycle detector
  const s = slope(data, state.metric, Math.min(60, data.length));
  const vol = volatility(data, state.metric, Math.min(60, data.length));
  // decide phase roughly
  let phase='分水岭/盘整';
  if(s>200 && vol<0.2) phase='成长期';
  if(s>1000 && vol>0.4) phase='过热期';
  if(s< -50) phase='衰退期';
  if(s>20 && vol<0.08) phase='成熟期';
  const phaseText = `${phase}（斜率 ${s.toFixed(2)}, 波动 ${vol.toFixed(3)}）`;

  document.getElementById('updatedAt').innerText = new Date().toLocaleString();
  document.getElementById('pulseArea').innerHTML = `<div>行业：<strong>${state.industry}</strong></div>
    <div>当前阶段：<strong style="color:var(--accent)">${phase}</strong></div>
    <div class="muted">解释：使用最近数据斜率与波动率自动判定，提示仅供参考。</div>`;

  // trend chart
  if(!trendChart) trendChart = echarts.init(document.getElementById('trendChart'));
  const option = {
    tooltip:{trigger:'axis'},
    xAxis:{type:'category', data:x},
    yAxis:{type:'value'},
    grid:{left:40,right:20,bottom:40,top:20},
    series:[
      {
        name:state.metric, type:'line', smooth:true, data:vals, areaStyle:{color:'rgba(46,139,87,0.12)'},
        lineStyle:{width:3, color:'#2E8B57'}, showSymbol:false,
        markPoint:{
          data: anomalies.map(a=>({name:'异常', value:a.value, xAxis: x.indexOf(a.date), yAxis: a.value, itemStyle:{color:'#ff4d4f'}}))
        },
        markArea: {
          // velocity zones: color bands based on growth rate thresholds (demo)
          data: [
            [{xAxis:0},{xAxis:x.length-1, itemStyle:{color:'rgba(46,139,87,0.02)'}}]
          ]
        }
      }
    ]
  };
  trendChart.setOption(option);
  trendChart.resize();

  // anomaly list
  const anomList = document.getElementById('anomalyList'); anomList.innerHTML='';
  if(anomalies.length===0) anomList.innerHTML = '<div class="muted">未检测到显著异常点（基于均值+3σ）</div>';
  else anomalies.forEach(a=>{
    const d = document.createElement('div');
    d.innerHTML = `<div style="font-weight:700">${a.date}</div><div class="muted">值：${a.value}</div>`;
    anomList.appendChild(d);
  });

  // render momentum radar
  renderRadar();

  // lead/lag sample
  renderLeadLag();
}

/* 雷达：动能（加速度/持续性/扩散度/波动/规模） */
function renderRadar(){
  const data = series();
  const n = data.length;
  // acceleration ~ slope of last 10 days
  const acc = slope(data,'count',10);
  const persist = (()=> {
    // consecutive increases in last 14 days
    const arr = data.slice(-14).map(d=>d.count);
    let c=0, maxc=0;
    for(let i=1;i<arr.length;i++){ if(arr[i]>arr[i-1]) c++; else { maxc=Math.max(maxc,c); c=0; } }
    return Math.min(14, maxc+1);
  })();
  const diffusion = (()=> {
    // how many industries move similarly: proxy using correlation row sums
    const corr = correlationMatrix();
    const idx = INDUSTRIES.indexOf(state.industry);
    const row = corr.mat[idx];
    const pos = row.filter(r=>r>0.4).length;
    return pos;
  })();
  const vol = volatility(data,'count',30);
  const scale = data.slice(-30).reduce((a,b)=>a+b.count,0)/30;

  const metrics = [
    {name:'加速度', value: Math.min(100, Math.abs(acc)/10)},
    {name:'持续性', value: Math.min(100, persist*7)},
    {name:'扩散度', value: Math.min(100, diffusion*18)},
    {name:'波动风险', value: Math.min(100, vol*120)},
    {name:'规模', value: Math.min(100, Math.log10(Math.max(1,scale))*12)}
  ];
  if(!radarChart) radarChart = echarts.init(document.getElementById('momentumRadar'));
  const option = {
    tooltip:{},
    radar: {
      indicator: metrics.map(m=>({name:m.name, max:100})),
      radius: '60%'
    },
    series:[{type:'radar', data:[{value:metrics.map(m=>m.value), name: state.industry}], areaStyle:{color:'rgba(46,139,87,0.12)'}}]
  };
  radarChart.setOption(option);
}

/* lead vs lag: show search (lead) vs count (lag) shifted */
function renderLeadLag(){
  const data = series();
  const arr = data.slice(-30);
  const x = arr.map(d=>d.date);
  const search = arr.map(d=>d.search);
  const count = arr.map(d=>d.count);
  const shiftedSearch = [null].concat(search.slice(0,-1)); // lead by 1
  if(!leadLagChart) leadLagChart = echarts.init(document.getElementById('leadLag'));
  const opt = {
    tooltip:{trigger:'axis'},
    legend:{data:['搜索量(领先)','创建量']},
    xAxis:{type:'category', data:x},
    yAxis:{type:'value'},
    series:[
      {name:'搜索量(领先)', type:'line', data:shiftedSearch, smooth:true},
      {name:'创建量', type:'line', data:count, smooth:true}
    ]
  };
  leadLagChart.setOption(opt);
}

/* compare bar */
function renderCompare(){
  const vals = INDUSTRIES.map(ind=>{
    const arr = timeSeries[ind] || [];
    const v = arr.slice(-state.range).reduce((a,b)=>a + (b[state.metric]||0),0);
    return {ind, v};
  }).sort((a,b)=>b.v-a.v);
  const names = vals.map(v=>v.ind), data = vals.map(v=>v.v);
  if(!compareChart) compareChart = echarts.init(document.getElementById('compareBar'));
  const opt = {
    tooltip:{}, grid:{left:40,right:20},
    xAxis:{type:'value'}, yAxis:{type:'category', data:names, inverse:true},
    series:[{type:'bar', data:data, itemStyle:{color:'#2E8B57'}}]
  };
  compareChart.setOption(opt);
}

/* heatmap synchronization (correlation matrix) */
function renderHeatmap(){
  const corr = correlationMatrix();
  const names = corr.names;
  const mat = corr.mat;
  const data = [];
  for(let i=0;i<names.length;i++) for(let j=0;j<names.length;j++) data.push([j,i, Number((mat[i][j]).toFixed(3))]);
  if(!heatChart) heatChart = echarts.init(document.getElementById('syncHeatmap'));
  const option = {
    tooltip:{formatter: p=>`${names[p.data[1]]} ↔ ${names[p.data[0]]} : ${p.data[2]}`},
    xAxis:{type:'category', data:names},
    yAxis:{type:'category', data:names},
    visualMap:{min:-1,max:1,calculable:false,orient:'horizontal',left:'center',inRange:{color:['#f3f6f5','#fff','#c8f3d9']}},
    series:[{type:'heatmap', data:data}]
  };
  heatChart.setOption(option);
}

/* sankey: high correlation links */
function renderSankey(){
  const sk = computeSankeyLinks();
  if(!sankeyChart) sankeyChart = echarts.init(document.getElementById('sankey'));
  const opt = {
    series:[{
      type:'sankey',
      data: sk.nodes,
      links: sk.links,
      emphasis:{focus:'adjacency'},
      lineStyle:{color:'gradient'}
    }]
  };
  sankeyChart.setOption(opt);
}

/* HHI list */
function renderHHI(){
  const arr = computeHHI();
  const el = document.getElementById('hhiList'); el.innerHTML='';
  arr.forEach(a=>{
    const d = document.createElement('div');
    d.style.display='flex'; d.style.justifyContent='space-between'; d.style.marginBottom='6px';
    d.innerHTML = `<div style="font-weight:700">${a.industry}</div><div class="muted">HHI: ${a.hhi} · TopShare: ${a.topShare}</div>`;
    el.appendChild(d);
  });
}

/* velocity zones: color bands based on %growth */
function renderVelocity(){
  const arr = series().slice(-state.range);
  const x = arr.map(d=>d.date);
  const vals = arr.map(d=>d.count);
  // compute pct change day-over-day
  const pct = [];
  for(let i=1;i<vals.length;i++) pct.push((vals[i]-vals[i-1])/Math.max(1,vals[i-1]));
  // velocity zones overlay using markArea
  const zones = [
    {name:'失速', start:-1, end:-0.05, color:'rgba(255,99,71,0.08)'},
    {name:'低速', start:-0.05, end:0.05, color:'rgba(255,206,86,0.06)'},
    {name:'加速', start:0.05, end:0.15, color:'rgba(46,139,87,0.06)'},
    {name:'过热', start:0.15, end:10, color:'rgba(46,139,87,0.12)'}
  ];
  if(!velocityChart) velocityChart = echarts.init(document.getElementById('velocityChart'));
  const option = {
    tooltip:{},
    xAxis:{type:'category', data:x.slice(1)},
    yAxis:{type:'value', axisLabel:{formatter:v=> (v*100).toFixed(1)+'%'}},
    series:[
      {type:'line', data:pct.map(v=>v), smooth:true, areaStyle:{color:'rgba(46,139,87,0.06)'}, lineStyle:{color:'#2E8B57'}},
      // add markAreas for zones visually (we'll add as background using graphic is complex; instead show colored bars via dataset)
    ],
  };
  velocityChart.setOption(option);
}

/* density: competitive density histogram of project scores in current industry */
function renderDensity(){
  const arr = projects.filter(p=>p.industry===state.industry).map(p=>p.score);
  if(arr.length===0){
    if(!densityChart) densityChart = echarts.init(document.getElementById('densityChart'));
    densityChart.setOption({title:{text:'无数据'},series:[]}); return;
  }
  const bins = 8;
  const min = Math.min(...arr), max = Math.max(...arr);
  const step = (max-min)/(bins);
  const binData = new Array(bins).fill(0);
  arr.forEach(v=>{
    const idx = Math.min(bins-1, Math.floor((v-min)/Math.max(1,step)));
    binData[idx]++;
  });
  const xlabels = new Array(bins).fill(0).map((_,i)=>`${Math.round(min+i*step)}-${Math.round(min+(i+1)*step)}`);
  if(!densityChart) densityChart = echarts.init(document.getElementById('densityChart'));
  const opt = {
    xAxis:{type:'category', data:xlabels},
    yAxis:{type:'value'},
    series:[{type:'bar', data:binData, itemStyle:{color:'#2E8B57'}}]
  };
  densityChart.setOption(opt);
}

/* compare chart already rendered separately (renderCompare) */

/* forecast chart */
function renderForecast(){
  const horizon = Number(document.getElementById('forecastHorizon').value);
  const preds = forecast(state.industry, state.metric, horizon);
  const x = preds.map(p=>`+${p.day}天`);
  const mean = preds.map(p=>p.mean);
  const lower = preds.map(p=>p.lower);
  const upper = preds.map(p=>p.upper);
  if(!forecastChart) forecastChart = echarts.init(document.getElementById('forecastChart'));
  const opt = {
    tooltip:{},
    xAxis:{type:'category', data:x},
    yAxis:{type:'value'},
    series:[
      {name:'预测上界', data:upper, type:'line', areaStyle:{opacity:0}, lineStyle:{opacity:0}},
      {name:'预测下界', data:lower, type:'line', areaStyle:{opacity:0}, lineStyle:{opacity:0}},
      {name:'预测均值', data:mean, type:'line', smooth:true, areaStyle:{color:'rgba(46,139,87,0.12)'}}
    ],
    visualMap:{show:false}
  };
  forecastChart.setOption(opt);
}

/* projects grid */
function renderProjects(){
  const page = state.page;
  const per = state.perPage;
  const filtered = projects.filter(p=>{
    if(state.industry && p.industry!==state.industry) return false;
    const kw = (document.getElementById('globalSearch').value || '').toLowerCase();
    if(kw){
      return p.title.toLowerCase().includes(kw) || p.desc.toLowerCase().includes(kw);
    }
    return true;
  }).sort((a,b)=>b.score-a.score);
  const total = filtered.length;
  const start = (page-1)*per;
  const list = filtered.slice(start, start+per);
  const grid = document.getElementById('projectGrid'); grid.innerHTML='';
  list.forEach(p=>{
    const div = document.createElement('div'); div.className='project';
    div.innerHTML = `<div class="thumb" style="background-image:url('https://picsum.photos/seed/${p.id}/600/300');background-size:cover"></div>
      <div class="p-body"><div style="font-weight:700">${p.title}</div><div class="muted">${p.desc} · ${p.industry} · ${p.type}</div>
      <div style="display:flex;justify-content:space-between;margin-top:10px"><div style="font-weight:700;color:var(--accent)">¥ ${p.price==='free'?0:Math.round(Math.random()*300)}</div><div class="muted">${p.views} 次浏览</div></div></div>`;
    grid.appendChild(div);
  });
  document.getElementById('pageInfo').innerText = `第 ${page} 页 · 共 ${Math.ceil(total/per)} 页 · ${total} 个结果`;
}

/* pagination */
function nextPage(){ state.page++; renderProjects(); }
function prevPage(){ if(state.page>1) state.page--; renderProjects(); }

/* quick actions */
function quick(mode){
  if(mode==='growth') { /* sort by views */ projects.sort((a,b)=>b.views-a.views); }
  if(mode==='hot') { projects.sort((a,b)=>b.score-a.score); }
  if(mode==='new') { projects.sort((a,b)=> new Date(b.created) - new Date(a.created)); }
  state.page = 1; renderProjects();
}

/* search */
function doSearch(){ state.page=1; renderProjects(); }

/* regenerate everything */
function regenAll(){
  genData();
  renderAll();
}

/* export snapshot (demo) */
function exportSnapshot(){ alert('示例：此功能可导出当前图表图片/CSV（示例未接后端）'); }

/* update metric/range */
function updateMetric(){ state.metric = document.getElementById('metricSelect').value; renderAll(); }
function updateRange(){ state.range = Number(document.getElementById('rangeSelect').value); renderAll(); }

/* render all */
function renderAll(){
  renderTrend();
  renderCompare();
  renderHeatmap();
  renderSankey();
  renderHHI();
  renderVelocity();
  renderDensity();
  renderForecast();
  renderProjects();
  renderKPI();
}

/* KPI render */
function renderKPI(){
  const kpiGrid = document.getElementById('kpiGrid'); kpiGrid.innerHTML='';
  const s = series();
  const totalProjects = projects.length;
  const new7 = s.slice(-7).reduce((a,b)=>a + (b.count||0),0);
  const activeUsers = Math.floor(1000 + Math.random()*9000);
  const hot = INDUSTRIES[Math.floor(Math.random()*INDUSTRIES.length)];
  const weeklyChange = (Math.random()*40-10).toFixed(1) + '%';
  const score = (Math.random()*1.3 + 4).toFixed(2) + ' / 5';
  const kpis = [
    {k:'总项目数', v: totalProjects},
    {k:'近7日创建量', v: new7},
    {k:'活跃用户(估)', v: activeUsers},
    {k:'最热行业', v: hot},
    {k:'周环比', v: weeklyChange},
    {k:'平台评分', v: score}
  ];
  kpis.forEach(it=>{
    const c = document.createElement('div'); c.className='kpi';
    c.innerHTML = `<div class="k">${it.k}</div><div class="v">${it.v}</div>`;
    kpiGrid.appendChild(c);
  });
}

/* initial load */
function initUI(){
  // tabs
  const tabs = document.getElementById('tabs'); tabs.innerHTML='';
  const allTab = document.createElement('div'); allTab.className='tab' + (state.industry==='全部'?' active':''); allTab.innerText='全部';
  allTab.onclick = ()=>{ state.industry=''; document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); allTab.classList.add('active'); renderAll(); };
  tabs.appendChild(allTab);
  INDUSTRIES.forEach(ind=>{
    const t = document.createElement('div'); t.className='tab' + (state.industry===ind?' active':''); t.innerText=ind;
    t.onclick = ()=>{ state.industry=ind; document.querySelectorAll('.tab').forEach(tt=>tt.classList.remove('active')); t.classList.add('active'); renderAll(); };
    tabs.appendChild(t);
  });
}

/* ============================
   启动
   ============================ */
function start(){
  genData(); initUI(); renderAll();
}
start();

/* 自动响应窗口大小 */
window.addEventListener('resize', ()=>{ [trendChart, radarChart, compareChart, heatChart, sankeyChart, velocityChart, densityChart, forecastChart, leadLagChart].forEach(c=>c && c.resize()); });

</script>
</body>
</html>
